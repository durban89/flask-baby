{% extends "base.j2" %}
{% block header %}
<h1>
{% block title %}
Chat  
{% endblock %}
</h1>
{% endblock %}
{% block content %}
<style type="text/css">
  .tips-container {
    text-align: center;
    color: #ccc;
    font-size: 18px;
  }

  .other-container,
  .self-container {
    border-bottom: 1px solid #ccc;
    margin-bottom: 5px
  }
  .avatar {
    width: 60px;
    height: 60px;
    display: inline-block;
    text-align: center;
    border: 1px solid #ccc;
    border-radius: 30px;
  }
</style>
<div>
  <h2 style="text-align: center">ChatRoom</h2>
  <div class="" id='chat-container'>
    
  </div>
  <div class="" style="margin-top: 10px">
    <textarea id='content' style="width: 100%; " rows='2'></textarea>
  </div>
  <div class="">
    <button id='submit' type="button" style="height: 60px;width: 200px; font-size: 18px">提交</button>
  </div>
  <div>
    <p>Average ping/pong latency: <b><span id="ping-pong"></span>ms</b></p>
  </div>
</div>
{% endblock %}
{% block script %}
<script src="{{ url_for('static', filename='js/jquery-3.4.1.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/socket.io.js') }}"></script>
<script type="text/javascript" charset="utf-8">
var submitBtn = $('#submit');
var chatRoomContainer = $('#chat-container');
var contentContainer = $('#content');

var tipsContainer = $('<div class="tips-container"></div>');
var otherContainer = $('<div class="other-container"></div>');

function addSelfMessage(message) {
  var selfContainer = $('<div class="self-container"></div>');
  var avatarContainer = $('<div style="text-align:right"><span class="avatar">头像</span></div>');
  selfContainer.append(avatarContainer);
  var messageContainer = $('<p></p>');
  messageContainer.text(message);
  selfContainer.append(messageContainer);
  chatRoomContainer.append(selfContainer);
}

function addOtherMessage(message) {
  var otherContainer = $('<div class="other-container"></div>');
  var avatarContainer = $('<div><span class="avatar">头像</span></div>');
  otherContainer.append(avatarContainer);
  var messageContainer = $('<p></p>');
  messageContainer.text(message);
  otherContainer.append(messageContainer);
  chatRoomContainer.append(otherContainer);
}

function addTipsMessage(message) {
  var tipsContainer = $('<div class="tips-container"></div>');
  tipsContainer.text(message);
  chatRoomContainer.append(tipsContainer);
}

var socket = io('/chat');
socket.on('connect', function () {
  socket.emit('join', {data: 'Join room one'});
});

socket.on('my_response', function (msg) {
  console.log('my response data ', msg.data);
  console.log('my response type ', msg.type);
  if (msg.type == 'tips') {
    addTipsMessage(msg.data);
  } else {
    addOtherMessage(msg.data);
  }
  
});

var pingPongTimes = [];
var startTime;
window.setInterval(function() {
  startTime = (new Date).getTime();
  socket.emit('my_ping');
}, 1000);

socket.on('my_pong', function() {
  var latency = (new Date).getTime() - startTime;
  pingPongTimes.push(latency);
  pingPongTimes = pingPongTimes.slice(-30); // keep last 30 samples
  var sum = 0;
  for (var i = 0; i < pingPongTimes.length; i++){
    sum += pingPongTimes[i];
  }
      
  $('#ping-pong').text(Math.round(10 * sum / pingPongTimes.length) / 10);
});

submitBtn.on('click', function(event) {
  socket.emit('my_event', {data: contentContainer.val(), type: 'self'});
  contentContainer.val('');
  return true;
});
</script>
{% endblock %}
